<!--
  支出記錄頁面模板
  為什麼使用表格顯示？
  1. 清晰呈現結構化資料
  2. 支援排序和篩選
  3. 符合使用者對財務記錄的期待
-->
<div class="expense-history-container">
  <div class="page-header">
    <h1>支出記錄</h1>
    <p>查看您的歷史支出資料</p>
  </div>

  <!-- 搜尋條件 -->
  <mat-card class="search-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>search</mat-icon>
        搜尋條件
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="searchForm" (ngSubmit)="onSearch()">
        <div class="search-fields">
          <!-- 年份選擇 -->
          <mat-form-field appearance="outline">
            <mat-label>年份</mat-label>
            <mat-select formControlName="year">
              <mat-option *ngFor="let year of years" [value]="year">
                {{ year }}年
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- 月份選擇 -->
          <mat-form-field appearance="outline">
            <mat-label>月份</mat-label>
            <mat-select formControlName="month">
              <mat-option *ngFor="let month of months" [value]="month.value">
                {{ month.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- 搜尋按鈕 -->
          <button 
            mat-raised-button 
            color="primary" 
            type="submit"
            [disabled]="isLoading">
            <mat-spinner diameter="20" *ngIf="isLoading"></mat-spinner>
            <mat-icon *ngIf="!isLoading">search</mat-icon>
            <span *ngIf="!isLoading">搜尋</span>
            <span *ngIf="isLoading">搜尋中...</span>
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- 載入指示器 -->
  <div class="loading-container" *ngIf="isLoading">
    <mat-spinner diameter="50"></mat-spinner>
    <p>載入中...</p>
  </div>

  <!-- 錯誤訊息 -->
  <div class="error-container" *ngIf="error && !isLoading">
    <mat-icon color="warn">error</mat-icon>
    <p>{{ error }}</p>
    <button mat-raised-button color="primary" (click)="refreshData()">
      重新載入
    </button>
  </div>

  <!-- 支出記錄表格 -->
  <mat-card class="history-card" *ngIf="!isLoading && !error">
    <mat-card-header>
      <mat-card-title>
        {{ searchForm.get('year')?.value }}年{{ getSelectedMonthName() }}支出記錄
      </mat-card-title>
      <mat-card-subtitle *ngIf="expenseHistory.length > 0">
        共 {{ expenseHistory.length }} 筆記錄，總金額 {{ formatCurrency(getTotalAmount()) }}
      </mat-card-subtitle>
    </mat-card-header>
    
    <mat-card-content>
      <!-- 有資料時顯示表格 -->
      <div *ngIf="expenseHistory.length > 0; else noDataTemplate">
        <table mat-table [dataSource]="expenseHistory" class="expense-table">
          <!-- 日期欄位 -->
          <ng-container matColumnDef="date">
            <th mat-header-cell *matHeaderCellDef>日期時間</th>
            <td mat-cell *matCellDef="let expense">{{ formatDate(expense.date) }}</td>
          </ng-container>

          <!-- 描述欄位 -->
          <ng-container matColumnDef="description">
            <th mat-header-cell *matHeaderCellDef>描述</th>
            <td mat-cell *matCellDef="let expense" class="description-cell">
              {{ expense.description }}
            </td>
          </ng-container>

          <!-- 類別欄位 -->
          <ng-container matColumnDef="category">
            <th mat-header-cell *matHeaderCellDef>類別</th>
            <td mat-cell *matCellDef="let expense">
              <span class="category-chip">{{ expense.category }}</span>
            </td>
          </ng-container>

          <!-- 金額欄位 -->
          <ng-container matColumnDef="amount">
            <th mat-header-cell *matHeaderCellDef class="amount-header">金額</th>
            <td mat-cell *matCellDef="let expense" class="amount-cell">
              {{ formatCurrency(expense.amount) }}
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>

        <!-- 總計欄位 -->
        <div class="total-section">
          <div class="total-amount">
            <strong>總支出：{{ formatCurrency(getTotalAmount()) }}</strong>
          </div>
        </div>
      </div>

      <!-- 無資料時的顯示 -->
      <ng-template #noDataTemplate>
        <div class="no-data">
          <mat-icon>inbox</mat-icon>
          <h3>尚無支出記錄</h3>
          <p>{{ searchForm.get('year')?.value }}年{{ getSelectedMonthName() }}還沒有任何支出記錄</p>
        </div>
      </ng-template>
    </mat-card-content>
  </mat-card>
</div>