<!-- 
檔案路徑: budget-assistant-web/src/app/features/dashboard/dashboard.component.html
修正 TypeScript 錯誤的 Dashboard 模板
-->

<div class="dashboard-container">
  <!-- 除錯資訊區塊 -->
  <div class="debug-info" style="background: #f0f0f0; padding: 10px; margin-bottom: 20px; border-radius: 4px;">
    <h4>🔧 除錯資訊</h4>
    <p><strong>載入狀態:</strong> {{ isLoading ? '載入中...' : '載入完成' }}</p>
    <p><strong>使用者:</strong> {{ currentUser?.username || '未載入' }}</p>
    <p><strong>錯誤:</strong> {{ error || '無' }}</p>
    <p><strong>預算資料:</strong> {{ budgetData ? '已載入' : '未載入' }}</p>
  </div>

  <!-- 頁面標題 -->
  <div class="page-header">
    <h1>儀表板</h1>
    <p *ngIf="currentUser">歡迎回來，{{ currentUser.username }}！</p>
  </div>

  <!-- 載入中狀態 -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>正在載入儀表板資料...</p>
  </div>

  <!-- 錯誤狀態 -->
  <div *ngIf="error && !isLoading" class="error-container">
    <mat-card class="error-card">
      <mat-card-header>
        <mat-icon color="warn">error</mat-icon>
        <mat-card-title>載入失敗</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <p>{{ error }}</p>
      </mat-card-content>
      <mat-card-actions>
        <button mat-button color="primary" (click)="refreshData()">
          <mat-icon>refresh</mat-icon>
          重試
        </button>
      </mat-card-actions>
    </mat-card>
  </div>

  <!-- 主要內容 -->
  <div *ngIf="!isLoading && !error" class="dashboard-content">
    
    <!-- 快速統計卡片 -->
    <div class="stats-grid">
      
      <!-- 本月預算卡片 -->
      <mat-card class="stat-card budget-card">
        <mat-card-header>
          <mat-icon mat-card-avatar color="primary">account_balance_wallet</mat-icon>
          <mat-card-title>本月預算</mat-card-title>
          <mat-card-subtitle>{{ currentMonth }}</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="budget-info" *ngIf="budgetData; else noBudgetData">
            <div class="budget-amount">
              <span class="total">總預算: ${{ budgetData.totalBudget | number }}</span>
              <span class="remaining">剩餘: ${{ budgetData.remainingCash | number }}</span>
            </div>
            <div class="budget-progress">
              <mat-progress-bar 
                mode="determinate" 
                [value]="budgetUtilizationPercentage"
                [color]="budgetUtilizationPercentage > 80 ? 'warn' : 'primary'">
              </mat-progress-bar>
              <span class="percentage">已使用 {{ budgetUtilizationPercentage }}%</span>
            </div>
          </div>
          <ng-template #noBudgetData>
            <p>尚未設定本月預算</p>
          </ng-template>
        </mat-card-content>
      </mat-card>

      <!-- 本月支出卡片 -->
      <mat-card class="stat-card expense-card">
        <mat-card-header>
          <mat-icon mat-card-avatar color="accent">shopping_cart</mat-icon>
          <mat-card-title>本月支出</mat-card-title>
          <mat-card-subtitle>累計金額</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="expense-amount">
            <!-- 修正：使用 totalCashExpenses 而不是 totalExpenses -->
            ${{ budgetData?.totalCashExpenses | number }}
          </div>
        </mat-card-content>
      </mat-card>

      <!-- 剩餘天數卡片 -->
      <mat-card class="stat-card days-card">
        <mat-card-header>
          <mat-icon mat-card-avatar>calendar_today</mat-icon>
          <mat-card-title>本月剩餘</mat-card-title>
          <mat-card-subtitle>天數</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="days-count">
            {{ remainingDays }} 天
          </div>
        </mat-card-content>
      </mat-card>

      <!-- 訂閱服務卡片 -->
      <mat-card class="stat-card subscription-card">
        <mat-card-header>
          <mat-icon mat-card-avatar color="accent">subscriptions</mat-icon>
          <mat-card-title>訂閱服務</mat-card-title>
          <mat-card-subtitle>本月費用</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="subscription-amount">
            ${{ budgetData?.totalSubscriptions | number }}
          </div>
        </mat-card-content>
      </mat-card>

      <!-- 信用卡卡片 -->
      <mat-card class="stat-card credit-card">
        <mat-card-header>
          <mat-icon mat-card-avatar color="warn">credit_card</mat-icon>
          <mat-card-title>信用卡消費</mat-card-title>
          <mat-card-subtitle>本月累計</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="credit-amount">
            ${{ budgetData?.totalCreditCard | number }}
          </div>
        </mat-card-content>
      </mat-card>

      <!-- 總計消費卡片 -->
      <mat-card class="stat-card total-card">
        <mat-card-header>
          <mat-icon mat-card-avatar>monetization_on</mat-icon>
          <mat-card-title>總計消費</mat-card-title>
          <mat-card-subtitle>信用卡+訂閱</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="total-amount">
            ${{ budgetData?.combinedCreditTotal | number }}
          </div>
        </mat-card-content>
      </mat-card>

    </div>

    <!-- 快速操作區域 -->
    <div class="quick-actions">
      <h2>快速操作</h2>
      <div class="action-buttons">
        <button mat-raised-button color="primary" (click)="navigateToExpenses()">
          <mat-icon>add</mat-icon>
          新增支出
        </button>
        <button mat-raised-button color="accent" (click)="navigateToBudget()">
          <mat-icon>account_balance</mat-icon>
          設定預算
        </button>
        <button mat-raised-button (click)="navigateToHistory()">
          <mat-icon>history</mat-icon>
          查看歷史
        </button>
      </div>
    </div>

    <!-- 測試按鈕 -->
    <div class="test-buttons" style="margin-top: 20px;">
      <h3>🧪 測試功能</h3>
      <button mat-button color="primary" (click)="refreshData()">重新載入資料</button>
      <button mat-button color="warn" (click)="authService.logout()">登出測試</button>
    </div>
    
  </div>
</div>